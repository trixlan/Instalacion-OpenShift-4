#---------------------------------------------------------------------
# Example configuration for a OpenShift Cluster
# Version actualizada al 15/01/2026
#
#---------------------------------------------------------------------

#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------

global
    log 127.0.0.1 local2
    maxconn 4000
    daemon

#---------------------------------------------------------------------
# common defaults that all the 'listen' and 'backend' sections will
# use if not designated in their block
#---------------------------------------------------------------------

defaults
    log global
    option dontlognull
    option redispatch                       # Si un backend falla después de aceptar conexión, HAProxy intenta otro.
    timeout connect 10s
    timeout check 10s                       # Define cuánto espera HAProxy al hacer health checks a los backends.
    timeout client 1m
    timeout server 1m
    retries 3

#---------------------------------------------------------------------
# frontend to OpenShift K8s API Server                                
#---------------------------------------------------------------------
frontend openshift-api-server
    bind *:6443
    mode tcp
    option tcplog                           # Registra información detallada de conexiones TCP
    default_backend openshift-api-server
#---------------------------------------------------------------------
# backend to OpenShift K8s API Server                                 
#---------------------------------------------------------------------
backend openshift-api-server
    mode tcp
    balance roundrobin
#    server bootstrap  10.2.82.2:6443 check
    server master0  10.2.82.3:6443 check
    server master1  10.2.82.4:6443 check
    server master2  10.2.82.5:6443 check

#---------------------------------------------------------------------
# frontend to OpenShift Machine Config Server                         
#---------------------------------------------------------------------
frontend machine-config-server
    bind *:22623
    mode tcp
    option tcplog                           # Registra información detallada de conexiones TCP
    default_backend machine-config-server
#---------------------------------------------------------------------
# backend to OpenShift Machine Config Server                          
#---------------------------------------------------------------------
backend machine-config-server
    mode tcp
    balance roundrobin
#    server bootstrap 10.2.82.2:22623 check
    server master0  10.2.82.3:22623 check
    server master1  10.2.82.4:22623 check
    server master2  10.2.82.5:22623 check

#---------------------------------------------------------------------
# frontend to OpenShift Machine Config Server (Add Workers)                   
#---------------------------------------------------------------------
frontend machine-config-server-add
    bind *:22624
    mode tcp
    option tcplog                           # Registra información detallada de conexiones TCP
    default_backend machine-config-server-add
#---------------------------------------------------------------------
# backend to OpenShift Machine Config Server (Add Workers)                   
#---------------------------------------------------------------------
backend machine-config-server-add
    mode tcp
    balance roundrobin
#    server bootstrap 10.2.82.2:22624 check
    server master0  10.2.82.3:22624 check
    server master1  10.2.82.4:22624 check
    server master2  10.2.82.5:22624 check

#---------------------------------------------------------------------
# frontend to HTTP                        
#---------------------------------------------------------------------
frontend ingress-http
    bind *:80
    mode http
    option forwardfor                       # HTTP headers
    default_backend ingress-http

#---------------------------------------------------------------------
# backend to HTTP                          
#---------------------------------------------------------------------
backend ingress-http
    mode http
    balance roundrobin
    server worker0 10.2.82.6:80 check
    server worker1 10.2.82.7:80 check
    server worker2 10.2.82.8:80 check

#---------------------------------------------------------------------
# frontend to HTTPS                        
#---------------------------------------------------------------------
frontend ingress-https
    bind *:443
    mode tcp
    option tcplog                           # Registra información detallada de conexiones TCP
    default_backend ingress-https

#---------------------------------------------------------------------
# backend to HTTPS                          
#---------------------------------------------------------------------
backend ingress-https
    mode tcp
    balance roundrobin
    server worker0 10.2.82.6:443 check
    server worker1 10.2.82.7:443 check
    server worker2 10.2.82.8:443 check
